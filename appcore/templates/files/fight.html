{% extends 'index.html' %}

{% block head %}
    {% load staticfiles %}
    <link rel="stylesheet" href="{% static 'style/fight.css' %}" type="text/css"/>
    <title>Hearthstone - Combat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
{% endblock %}

{% block body %}

    <h2 class="subtitle">Combat</h2>
    <a class="button is-info" href="/tableau-de-bord/">Tableau de bord</a>

    <div class="panel_fight">

        {% if type == 'ia' %}
        <!-- IA -->
        <div class="panel_background_ia">
            {% for card in cards_ia %}
                <div class="frame_card frame_background_ia"
                    id="card_ia_{{forloop.counter}}">
                    <div class="card">
                        <p id="id_name">{{card.name}}</p>
                        <p id="id_cost">{{card.cost}}</p>
                        <p id="id_health">{{card.health}}</p>
                        <p id="id_attack">{{card.attack}}</p>
                        <p id="id_text">{{card.text|striptags }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="panel_ia">
            <div class="panel_deck_ia">
                <div class="fight_deck">
                    <div class="card"></div>
                </div>
            </div>
            <div class="panel_hand_ia"></div>
        </div>
        <div class="panel_ground_ia"></div>
        <div class="panel_ground_user"></div>

        <!-- USER -->
        <div class="panel_user">
            <div class="panel_hand_user">
            </div>
            <div class="panel_deck_user">
                <div class="fight_deck" id="fight_deck_user">
                    <div class="card"></div>
                </div>
            </div>
        </div>

        <div class="panel_background_user">
            {% for card in cards_user %}
                <div class="frame_card frame_background_user"
                    id="card_user_{{forloop.counter}}">
                    <div class="card">
                        <p id="id_name">{{card.name}}</p>
                        <p id="id_cost">{{card.cost}}</p>
                        <p id="id_health">{{card.health}}</p>
                        <p id="id_attack">{{card.attack}}</p>
                        <p id="id_text">{{card.text |striptags }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% endif %}

    </div>

    <script type="text/javascript">

        groundIA= []
        groundUser= []

        function backgroundToHand(player) {
            if(player==='user') {
                var frameCards = $('.frame_background_user')
                random = Math.floor(Math.random() * frameCards.length);
                cardRdm = frameCards[random]
                $(cardRdm).removeClass('frame_background_user').addClass('frame_hand_user')
                $('.panel_hand_user').append(cardRdm)
            }
            if(player==='ia') {
                var frameCards = $('.frame_background_ia')
                random = Math.floor(Math.random() * frameCards.length);
                cardRdm = frameCards[random]
                $(cardRdm).removeClass('frame_background_ia').addClass('frame_hand_ia')
                $('.panel_hand_ia').append(cardRdm)
            }
        }

        $('body').delegate('.frame_hand_user', 'click', function(e){
            if($('.frame_ground_user').length <= 5){
                // console.log('HERE IS USER => ', $(this).attr('id'))
                cardToGround = {
                    'id': parseInt($(this).attr('id').split('_')[1]),
                    'cost': parseInt($(this).find("#id_cost").text(), 10),
                    'health': parseInt($(this).find("#id_health").text(), 10),
                    'attack': parseInt($(this).find("#id_attack").text(), 10)
                }
                groundUser.push(cardToGround)
                $(this).removeClass('frame_hand_user').addClass('frame_ground_user')
                $('.panel_ground_user').append(this)
                $(this).unbind( "click" ) // remove 1Â° click event

                $(this).click(function(){ // click card ground
                    card_attack_user = this
                    // console.log('HERE IS card_attack_user => ', card_attack_user)

                    $('.frame_hand_user').click(function(){
                        card_defense_ia = this
                        console.log('HERE IS card_defense_ia => ', card_defense_ia, ' & card_attack_user => ', card_attack_user)

                    })
                })
            }
        })

        function handToGround(player) {
            if(player==='ia') {
                if($('.frame_ground_ia').length <= 5){
                    var frameCards = $('.frame_hand_ia')
                    random = Math.floor(Math.random() * frameCards.length)
                    cardRdm = frameCards[random]

                    $(cardRdm).click(function(){
                        // console.log('HERE IS IA => ', $(this).attr('id'))
                        cardToGround = {
                            'id': parseInt($(this).attr('id').split('_')[1]),
                            'cost': parseInt($(this).find("#id_cost").text(), 10),
                            'health': parseInt($(this).find("#id_health").text(), 10),
                            'attack': parseInt($(this).find("#id_attack").text(), 10)
                        }
                        groundIA.push(cardToGround)
                        $(this).removeClass('frame_hand_ia').addClass('frame_ground_ia')
                        $('.panel_ground_ia').append(this)
                    });

                    $(cardRdm).trigger('click') // simulate click
                }
            }
        }

        if($('.frame_hand_user').length==0){
            for(i=0;i<5;i++){
                backgroundToHand('user') // User - background to hand
            }
            handToGround('user') // User - hand to ground
        }

        $('#fight_deck_user').click(function(){ // User - onclick deck - background to hand
            if($('.frame_hand_user').length <= 4){
                backgroundToHand('user')
            }
        })

        if($('.frame_hand_ia').length==0){
            for(i=0;i<5;i++){
                backgroundToHand('ia') // IA - background to hand
            }
        }

        setInterval(function(){ // IA - Interval 3sec - hand to ground
            if($('.frame_hand_ia').length <= 4){
                backgroundToHand('ia')
            }
            handToGround('ia')
        }, 3000);

    </script>

{% endblock %}